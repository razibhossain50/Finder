<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Uniqueness Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Email Uniqueness Test Suite</h1>
        <p>This page tests the email uniqueness functionality of the signup system.</p>
        
        <div class="test-section">
            <h3>Configuration</h3>
            <div class="form-group">
                <label for="apiUrl">API Base URL:</label>
                <input type="text" id="apiUrl" value="http://localhost:3001/api" placeholder="http://localhost:3001/api">
            </div>
            <div class="form-group">
                <label for="testEmail">Test Email:</label>
                <input type="email" id="testEmail" value="test.uniqueness@example.com" placeholder="test.uniqueness@example.com">
            </div>
        </div>

        <div class="test-section">
            <h3>Test 1: Create First User</h3>
            <p>This should succeed and create a new user account.</p>
            <button onclick="runTest1()" id="test1Btn">Run Test 1</button>
            <div id="test1Result"></div>
        </div>

        <div class="test-section">
            <h3>Test 2: Duplicate Email</h3>
            <p>This should fail with a "email already exists" error.</p>
            <button onclick="runTest2()" id="test2Btn">Run Test 2</button>
            <div id="test2Result"></div>
        </div>

        <div class="test-section">
            <h3>Test 3: Case Insensitive</h3>
            <p>This should fail even with different case (UPPERCASE email).</p>
            <button onclick="runTest3()" id="test3Btn">Run Test 3</button>
            <div id="test3Result"></div>
        </div>

        <div class="test-section">
            <h3>Test 4: Whitespace Normalization</h3>
            <p>This should fail even with leading/trailing spaces.</p>
            <button onclick="runTest4()" id="test4Btn">Run Test 4</button>
            <div id="test4Result"></div>
        </div>

        <div class="test-section">
            <h3>Test 5: New Email</h3>
            <p>This should succeed with a different email address.</p>
            <button onclick="runTest5()" id="test5Btn">Run Test 5</button>
            <div id="test5Result"></div>
        </div>

        <div class="test-section">
            <h3>Run All Tests</h3>
            <button onclick="runAllTests()" id="runAllBtn">Run All Tests</button>
            <button onclick="clearResults()" id="clearBtn">Clear Results</button>
        </div>
    </div>

    <script>
        async function makeSignupRequest(userData) {
            const apiUrl = document.getElementById('apiUrl').value;
            
            try {
                const response = await fetch(`${apiUrl}/auth/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();
                
                return {
                    success: response.ok,
                    status: response.status,
                    data: data
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        function showResult(elementId, result, expectedSuccess = true) {
            const element = document.getElementById(elementId);
            let className, message;

            if (result.error) {
                className = 'error';
                message = `‚ùå Network Error: ${result.error}`;
            } else if (result.success === expectedSuccess) {
                className = 'success';
                if (expectedSuccess) {
                    message = `‚úÖ Success: User created (ID: ${result.data.user?.id})`;
                } else {
                    message = `‚úÖ Correctly rejected: ${result.data.message}`;
                }
            } else {
                className = 'error';
                if (expectedSuccess) {
                    message = `‚ùå Unexpected failure: ${result.data.message || 'Unknown error'}`;
                } else {
                    message = `‚ùå Should have been rejected but succeeded: User ID ${result.data.user?.id}`;
                }
            }

            element.innerHTML = `<div class="result ${className}">${message}</div>`;
        }

        function showLoading(elementId, message = 'Running test...') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result loading">‚è≥ ${message}</div>`;
        }

        async function runTest1() {
            const testEmail = document.getElementById('testEmail').value;
            showLoading('test1Result', 'Creating first user...');
            
            const userData = {
                fullName: 'Test User One',
                email: testEmail,
                password: 'TestPassword123!',
                confirmPassword: 'TestPassword123!'
            };

            const result = await makeSignupRequest(userData);
            showResult('test1Result', result, true);
        }

        async function runTest2() {
            const testEmail = document.getElementById('testEmail').value;
            showLoading('test2Result', 'Attempting duplicate signup...');
            
            const userData = {
                fullName: 'Test User Two',
                email: testEmail,
                password: 'TestPassword123!',
                confirmPassword: 'TestPassword123!'
            };

            const result = await makeSignupRequest(userData);
            showResult('test2Result', result, false);
        }

        async function runTest3() {
            const testEmail = document.getElementById('testEmail').value;
            showLoading('test3Result', 'Testing case insensitivity...');
            
            const userData = {
                fullName: 'Test User Three',
                email: testEmail.toUpperCase(),
                password: 'TestPassword123!',
                confirmPassword: 'TestPassword123!'
            };

            const result = await makeSignupRequest(userData);
            showResult('test3Result', result, false);
        }

        async function runTest4() {
            const testEmail = document.getElementById('testEmail').value;
            showLoading('test4Result', 'Testing whitespace normalization...');
            
            const userData = {
                fullName: 'Test User Four',
                email: `  ${testEmail}  `,
                password: 'TestPassword123!',
                confirmPassword: 'TestPassword123!'
            };

            const result = await makeSignupRequest(userData);
            showResult('test4Result', result, false);
        }

        async function runTest5() {
            const testEmail = document.getElementById('testEmail').value;
            const newEmail = testEmail.replace('@', '.new@');
            showLoading('test5Result', 'Creating user with new email...');
            
            const userData = {
                fullName: 'Test User Five',
                email: newEmail,
                password: 'TestPassword123!',
                confirmPassword: 'TestPassword123!'
            };

            const result = await makeSignupRequest(userData);
            showResult('test5Result', result, true);
        }

        async function runAllTests() {
            const runAllBtn = document.getElementById('runAllBtn');
            runAllBtn.disabled = true;
            runAllBtn.textContent = 'Running Tests...';

            try {
                await runTest1();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await runTest2();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await runTest3();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await runTest4();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await runTest5();
            } finally {
                runAllBtn.disabled = false;
                runAllBtn.textContent = 'Run All Tests';
            }
        }

        function clearResults() {
            const resultElements = ['test1Result', 'test2Result', 'test3Result', 'test4Result', 'test5Result'];
            resultElements.forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
        }

        // Show info message on load
        window.onload = function() {
            document.body.insertAdjacentHTML('afterbegin', 
                '<div class="result info" style="margin-bottom: 20px;">' +
                'üí° <strong>Note:</strong> Make sure your backend server is running and accessible at the configured API URL. ' +
                'You may need to clean up test users from your database after running these tests.' +
                '</div>'
            );
        };
    </script>
</body>
</html>